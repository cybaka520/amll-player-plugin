name: ä¸Šä¼ æ’ä»¶

on:
  issues:
    types: [opened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  handle:
    if: contains(github.event.issue.labels.*.name, 'æ’ä»¶ä¸Šä¼ /æ›´æ–°')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: é…ç½® Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: å®‰è£…å·¥å…·
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq curl

      - name: è§£æissue
        id: meta
        run: |
          # å°† issue body ä¿å­˜åˆ°æ–‡ä»¶ï¼Œé¿å… shell è½¬ä¹‰é—®é¢˜
          cat > /tmp/issue_body.txt << 'EOL'
          ${{ github.event.issue.body }}
          EOL

          # æå–åŸºæœ¬ä¿¡æ¯
          NAME=$(awk '/^### æ’ä»¶å/{getline; while ($0=="") getline; print; exit}' /tmp/issue_body.txt | xargs)
          DESC=$(awk '/^### æ’ä»¶ç®€ä»‹/{getline; while ($0=="") getline; print; exit}' /tmp/issue_body.txt | xargs)
          AUTHOR=$(awk '/^### æ’ä»¶ä½œè€…/{getline; while ($0=="") getline; print; exit}' /tmp/issue_body.txt | xargs)
          URL=$(awk '/^### æ’ä»¶ä¸‹è½½ç›´é“¾/{getline; while ($0=="") getline; print; exit}' /tmp/issue_body.txt | xargs)
          VERSION=$(awk '/^### æ’ä»¶ç‰ˆæœ¬å·/{getline; while ($0=="") getline; print; exit}' /tmp/issue_body.txt | xargs)

          # éªŒè¯å¿…å¡«å­—æ®µ
          if [ -z "$NAME" ] || [ -z "$URL" ] || [ -z "$VERSION" ]; then
            echo "error=ç¼ºå°‘å¿…å¡«å­—æ®µï¼ˆæ’ä»¶å/ä¸‹è½½ç›´é“¾/ç‰ˆæœ¬å·ï¼‰" >> $GITHUB_OUTPUT
            echo "success=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # æå– SVG å†…å®¹ï¼ˆä» "### SVG å›¾æ ‡" ä¹‹ååˆ°ä¸‹ä¸€ä¸ª "###" æˆ–æ–‡ä»¶æœ«å°¾ï¼‰
          awk '/^### SVG å›¾æ ‡/{flag=1; next} /^###/{flag=0} flag' /tmp/issue_body.txt > /tmp/svg_content.txt
          
          # ç§»é™¤å¼€å¤´å’Œç»“å°¾çš„ç©ºè¡Œ
          sed -i '/./,$!d' /tmp/svg_content.txt
          # ä¿®å¤çš„ sed å‘½ä»¤
          sed -i ':a' -e '/^\s*$/d;N;ba' /tmp/svg_content.txt 2>/dev/null || true

          # ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
          SAFE_NAME=$(echo "$NAME" | tr -cd '[:alnum:]_-' | tr '[:upper:]' '[:lower:]')
          if [ -z "$SAFE_NAME" ]; then
            SAFE_NAME="plugin-$(date +%s)"
          fi

          # ä¿å­˜ SVG å†…å®¹è·¯å¾„
          echo "SVG_FILE=/tmp/svg_content.txt" >> $GITHUB_OUTPUT
          echo "SAFE_NAME=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "NAME=$NAME" >> $GITHUB_OUTPUT
          echo "DESC=$DESC" >> $GITHUB_OUTPUT
          echo "AUTHOR=$AUTHOR" >> $GITHUB_OUTPUT
          echo "URL=$URL" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT

          echo "==== Parsed ====="
          echo "NAME=[$NAME]"
          echo "SAFE_NAME=[$SAFE_NAME]"
          echo "DESC=[$DESC]"
          echo "AUTHOR=[$AUTHOR]"
          echo "URL=[$URL]"
          echo "VERSION=[$VERSION]"
          echo "SVG å†…å®¹:"
          cat /tmp/svg_content.txt || echo "(æ—  SVG å†…å®¹)"
          echo ""
          echo "SVG å­—èŠ‚æ•°: $(wc -c < /tmp/svg_content.txt)"

      - name: è§£æå¤±è´¥å¤„ç†
        if: steps.meta.outputs.success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const error = '${{ steps.meta.outputs.error }}' || 'è§£æ Issue å¤±è´¥';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `@${{ github.event.issue.user.login }} ${error}ï¼Œè¯·æ£€æŸ¥ Issue æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚`
            });
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['éœ€è¦ä¿®æ”¹']
            });
            core.setFailed(error);

      - name: ä¸‹è½½æ’ä»¶
        if: steps.meta.outputs.success == 'true'
        id: dl
        continue-on-error: true
        run: |
          set -e
          URL="${{ steps.meta.outputs.URL }}"
          mkdir -p raw-plugin
          
          # ä¸‹è½½å¹¶æ£€æŸ¥ HTTP çŠ¶æ€ç 
          HTTP_CODE=$(curl -L -o raw-plugin/plugin.js -w "%{http_code}" -s --fail-with-body "$URL" || echo "000")
          
          if [ "$HTTP_CODE" != "200" ] || [ ! -s raw-plugin/plugin.js ]; then
            echo "success=false" >> $GITHUB_OUTPUT
            echo "error=ä¸‹è½½å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_CODE" >> $GITHUB_OUTPUT
            echo "ä¸‹è½½å¤±è´¥ï¼ŒHTTP çŠ¶æ€ç : $HTTP_CODE"
            exit 0
          fi
          
          # ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
          TS=$(date +%s)
          RAND=$(openssl rand -hex 4)
          FILENAME="${TS}-${{ github.event.issue.user.login }}-${RAND}.js"
          mv raw-plugin/plugin.js raw-plugin/"$FILENAME"
          
          echo "success=true" >> $GITHUB_OUTPUT
          echo "FILENAME=$FILENAME" >> $GITHUB_OUTPUT
          echo "æ’ä»¶ä¸‹è½½æˆåŠŸ: $FILENAME ($(stat -f%z raw-plugin/"$FILENAME" 2>/dev/null || stat -c%s raw-plugin/"$FILENAME") bytes)"

      - name: ä¸‹è½½å¤±è´¥å¤„ç†
        if: steps.meta.outputs.success == 'true' && steps.dl.outputs.success != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const error = '${{ steps.dl.outputs.error }}' || 'æ’ä»¶ä¸‹è½½å¤±è´¥';
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `@${{ github.event.issue.user.login }} ${error}ï¼Œè¯·æ£€æŸ¥ç›´é“¾æ˜¯å¦æœ‰æ•ˆã€‚`
            });
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['éœ€è¦ä¿®æ”¹']
            });
            core.setFailed(error);

      - name: æ·»åŠ å…ƒæ•°æ® & å†™å…¥ SVG
        if: steps.dl.outputs.success == 'true'
        run: |
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p metadata raw-plugin

          # åˆ›å»ºå…ƒæ•°æ®æ¡ç›®
          ENTRY=$(jq -n \
            --arg fn "${{ steps.dl.outputs.FILENAME }}" \
            --arg name "${{ steps.meta.outputs.NAME }}" \
            --arg author "${{ steps.meta.outputs.AUTHOR }}" \
            --arg desc "${{ steps.meta.outputs.DESC }}" \
            --arg version "${{ steps.meta.outputs.VERSION }}" \
            --arg issue "${{ github.event.issue.number }}" \
            '{filename:$fn, name:$name, author:$author, description:$desc, version:$version, issue:$issue}')
          
          echo "$ENTRY" >> metadata/raw-plugin-index.jsonl

          # å†™å…¥ SVG æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          ICON_FILE="raw-plugin/${{ steps.meta.outputs.SAFE_NAME }}.svg"
          if [ -s "${{ steps.meta.outputs.SVG_FILE }}" ]; then
            cp "${{ steps.meta.outputs.SVG_FILE }}" "$ICON_FILE"
            echo "SVG æ–‡ä»¶å·²åˆ›å»º: $ICON_FILE"
            ls -lh "$ICON_FILE"
            echo "SVG å†…å®¹é¢„è§ˆ:"
            head -n 5 "$ICON_FILE"
          else
            echo "æœªæä¾› SVG å›¾æ ‡ï¼Œè·³è¿‡"
          fi
          
          # æ·»åŠ åˆ° git
          git add raw-plugin/${{ steps.dl.outputs.FILENAME }} metadata/raw-plugin-index.jsonl
          if [ -f "$ICON_FILE" ]; then
            git add "$ICON_FILE"
          fi

      - name: ç”Ÿæˆå”¯ä¸€åˆ†æ”¯å
        if: steps.dl.outputs.success == 'true'
        id: branch
        run: |
          TS=$(date +%s%3N)
          BRANCH="plugin/${{ steps.meta.outputs.SAFE_NAME }}-${{ github.event.issue.number }}-$TS"
          echo "name=$BRANCH" >> $GITHUB_OUTPUT
          echo "åˆ†æ”¯å: $BRANCH"

      - name: åˆ›å»º PR
        if: steps.dl.outputs.success == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.branch.outputs.name }}
          title: "æ’ä»¶ä¸Šä¼ : ${{ steps.meta.outputs.NAME }}"
          body: |
            **æ’ä»¶åï¼š** ${{ steps.meta.outputs.NAME }}  
            **ä½œè€…ï¼š** @${{ github.event.issue.user.login }}  
            **ç‰ˆæœ¬å·ï¼š** ${{ steps.meta.outputs.VERSION }}  
            **ç®€ä»‹ï¼š** ${{ steps.meta.outputs.DESC }}  
            **æ–‡ä»¶åï¼š** ${{ steps.dl.outputs.FILENAME }}  
            **æ¥æº Issueï¼š** #${{ github.event.issue.number }}
          base: main
          commit-message: "Add plugin ${{ steps.meta.outputs.NAME }} from #${{ github.event.issue.number }}"
          delete-branch: true

      - name: PR åˆ›å»ºå¤±è´¥å¤„ç†
        if: steps.dl.outputs.success == 'true' && steps.cpr.outputs.pull-request-number == ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `@${{ github.event.issue.user.login }} PR åˆ›å»ºå¤±è´¥ã€‚`
            });
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['éœ€è¦äººå·¥å¤„ç†']
            });
            core.setFailed('PR åˆ›å»ºå¤±è´¥');

      - name: æˆåŠŸåˆ›å»º PR åå…³é—­ Issue
        if: steps.dl.outputs.success == 'true' && steps.cpr.outputs.pull-request-number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = ${{ github.event.issue.number }};
            const author       = '${{ github.event.issue.user.login }}';
            const pr_url       = '${{ steps.cpr.outputs.pull-request-url }}';
            const pr_number    = '${{ steps.cpr.outputs.pull-request-number }}';
            
            await github.rest.issues.createComment({
              issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `@${author} å·²åˆ›å»º PR #${pr_number}ï¼š${pr_url}\n\nè¯·ç­‰å¾…å®¡æ ¸ã€‚ğŸ‰`
            });
            
            await github.rest.issues.update({
              issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              state_reason: 'completed'
            });
