name: å‘å¸ƒæ’ä»¶

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write

jobs:
  publish:
    if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'plugin/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å®‰è£… jq
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq

      - name: è¯»å– PR ä¿¡æ¯
        id: meta
        run: |
          # ä¿å­˜ PR body åˆ°æ–‡ä»¶
          cat > /tmp/pr_body.txt << 'EOFBODY'
          ${{ github.event.pull_request.body }}
          EOFBODY
          
          # æå–å‡½æ•°
          get_field() {
            local label="$1"
            awk -v label="$label" '
              $0 ~ "^\\*\\*" label "[ï¼š:]\\*\\*" {
                getline
                while ($0 == "") getline
                print
                exit
              }
            ' /tmp/pr_body.txt | xargs
          }
          
          # æå–å„å­—æ®µ
          NAME=$(get_field "æ’ä»¶å")
          AUTHOR=$(get_field "ä½œè€…" | sed 's/^@//')
          VERSION=$(get_field "ç‰ˆæœ¬å·")
          DESC=$(get_field "ç®€ä»‹")
          FILENAME=$(get_field "æ–‡ä»¶å")
          
          # å¦‚æœæ’ä»¶åä¸ºç©ºï¼Œä» PR æ ‡é¢˜æå–
          if [ -z "$NAME" ]; then
            TITLE="${{ github.event.pull_request.title }}"
            # å°è¯• "Add plugin XXX from #123" æ ¼å¼
            if [[ "$TITLE" =~ ^Add\ plugin\ (.+)\ from\ #[0-9]+$ ]]; then
              NAME="${BASH_REMATCH[1]}"
            # å°è¯• "æ’ä»¶ä¸Šä¼ : XXX" æ ¼å¼
            elif [[ "$TITLE" =~ æ’ä»¶ä¸Šä¼ [ï¼š:]\ *(.+)$ ]]; then
              NAME="${BASH_REMATCH[1]}"
            fi
          fi
          
          # ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œä¿ç•™ä¸­æ–‡ã€å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼‰
          SAFE_NAME=$(echo "$NAME" | sed 's/[^a-zA-Z0-9_\u4e00-\u9fa5-]/_/g' | tr '[:upper:]' '[:lower:]')
          
          # å¦‚æœ SAFE_NAME ä¸ºç©ºï¼Œä½¿ç”¨æ—¶é—´æˆ³
          if [ -z "$SAFE_NAME" ]; then
            SAFE_NAME="plugin_$(date +%s)"
          fi
          
          echo "==== è§£æç»“æœ ===="
          echo "NAME=$NAME"
          echo "SAFE_NAME=$SAFE_NAME"
          echo "AUTHOR=$AUTHOR"
          echo "VERSION=$VERSION"
          echo "DESC=$DESC"
          echo "FILENAME=$FILENAME"
          
          # è¾“å‡ºåˆ° GITHUB_OUTPUT
          echo "NAME=$NAME" >> $GITHUB_OUTPUT
          echo "SAFE_NAME=$SAFE_NAME" >> $GITHUB_OUTPUT
          echo "AUTHOR=$AUTHOR" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "DESC=$DESC" >> $GITHUB_OUTPUT
          echo "FILENAME=$FILENAME" >> $GITHUB_OUTPUT

      - name: éªŒè¯å¿…å¡«å­—æ®µ
        run: |
          NAME="${{ steps.meta.outputs.NAME }}"
          AUTHOR="${{ steps.meta.outputs.AUTHOR }}"
          FILENAME="${{ steps.meta.outputs.FILENAME }}"
          
          if [ -z "$NAME" ] || [ -z "$FILENAME" ]; then
            echo "é”™è¯¯: ç¼ºå°‘å¿…å¡«å­—æ®µ"
            echo "NAME=[$NAME]"
            echo "AUTHOR=[$AUTHOR]"
            echo "FILENAME=[$FILENAME]"
            exit 1
          fi

      - name: è°ƒè¯•ä¿¡æ¯
        run: |
          echo "==== æå–çš„å…ƒæ•°æ® ===="
          echo "NAME=[${{ steps.meta.outputs.NAME }}]"
          echo "SAFE_NAME=[${{ steps.meta.outputs.SAFE_NAME }}]"
          echo "AUTHOR=[${{ steps.meta.outputs.AUTHOR }}]"
          echo "VERSION=[${{ steps.meta.outputs.VERSION }}]"
          echo "FILENAME=[${{ steps.meta.outputs.FILENAME }}]"
          echo ""
          echo "==== raw-plugin ç›®å½•å†…å®¹ ===="
          ls -lh raw-plugin/ || echo "raw-plugin ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "==== æŸ¥æ‰¾å¯èƒ½çš„ SVG æ–‡ä»¶ ===="
          find raw-plugin -name "*.svg" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° SVG æ–‡ä»¶"

      - name: å¤åˆ¶æ’ä»¶åˆ°å‘å¸ƒç›®å½•
        run: |
          SRC="raw-plugin/${{ steps.meta.outputs.FILENAME }}"
          
          # ç”Ÿæˆç›®æ ‡æ–‡ä»¶å
          if [ -n "${{ steps.meta.outputs.AUTHOR }}" ]; then
            DST="amll-plugin/${{ steps.meta.outputs.SAFE_NAME }}-${{ steps.meta.outputs.AUTHOR }}.js"
          else
            DST="amll-plugin/${{ steps.meta.outputs.SAFE_NAME }}.js"
          fi
          
          mkdir -p amll-plugin
          
          # æ£€æŸ¥æºæ–‡ä»¶
          if [ ! -f "$SRC" ]; then
            echo "é”™è¯¯: æºæ–‡ä»¶ä¸å­˜åœ¨: $SRC"
            echo "raw-plugin ç›®å½•å†…å®¹:"
            ls -la raw-plugin/
            exit 1
          fi
          
          # å¤åˆ¶æ’ä»¶æ–‡ä»¶
          cp "$SRC" "$DST"
          echo "å·²å¤åˆ¶æ’ä»¶: $SRC -> $DST"
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶å›¾æ ‡ï¼ˆä½¿ç”¨ SAFE_NAMEï¼‰
          # å°è¯•å¤šç§å¯èƒ½çš„æ–‡ä»¶å
          ICON_DST="${DST%.js}.svg"
          FOUND_ICON=false
          
          for ICON_SRC in \
            "raw-plugin/${{ steps.meta.outputs.SAFE_NAME }}.svg" \
            "raw-plugin/${{ steps.meta.outputs.NAME }}.svg"; do
            if [ -f "$ICON_SRC" ]; then
              cp "$ICON_SRC" "$ICON_DST"
              echo "å·²å¤åˆ¶å›¾æ ‡: $ICON_SRC -> $ICON_DST"
              FOUND_ICON=true
              break
            fi
          done
          
          if [ "$FOUND_ICON" = false ]; then
            echo "è­¦å‘Š: æœªæ‰¾åˆ°å›¾æ ‡æ–‡ä»¶ï¼Œå·²è·³è¿‡"
          fi
          
      - name: ç”Ÿæˆç´¢å¼•
        run: |
          INDEX="amll-plugin/index.jsonl"
          PLUGIN="${{ steps.meta.outputs.NAME }}"
          AUTHOR="${{ steps.meta.outputs.AUTHOR }}"
          SAFE_NAME="${{ steps.meta.outputs.SAFE_NAME }}"
          
          # ç”Ÿæˆæ–‡ä»¶å
          if [ -n "$AUTHOR" ]; then
            FILENAME="${SAFE_NAME}-${AUTHOR}.js"
            ICON_NAME="${SAFE_NAME}-${AUTHOR}.svg"
          else
            FILENAME="${SAFE_NAME}.js"
            ICON_NAME="${SAFE_NAME}.svg"
          fi
          
          # æ£€æŸ¥å›¾æ ‡æ˜¯å¦å­˜åœ¨
          if [ -f "amll-plugin/$ICON_NAME" ]; then
            HAS_ICON=true
          else
            HAS_ICON=false
            ICON_NAME=""
          fi
          
          # åˆ›å»ºæ–°è®°å½•
          if [ "$HAS_ICON" = true ]; then
            NEW=$(jq -n \
              --arg fn "$FILENAME" \
              --arg icon "$ICON_NAME" \
              --arg name "$PLUGIN" \
              --arg desc "${{ steps.meta.outputs.DESC }}" \
              --arg author "$AUTHOR" \
              --arg version "${{ steps.meta.outputs.VERSION }}" \
              '{filename:$fn, icon:$icon, plugin:$name, description:$desc, author:$author, version:$version}')
          else
            NEW=$(jq -n \
              --arg fn "$FILENAME" \
              --arg name "$PLUGIN" \
              --arg desc "${{ steps.meta.outputs.DESC }}" \
              --arg author "$AUTHOR" \
              --arg version "${{ steps.meta.outputs.VERSION }}" \
              '{filename:$fn, plugin:$name, description:$desc, author:$author, version:$version}')
          fi

          # åˆ›å»ºç´¢å¼•æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          touch "$INDEX"

          # åˆ é™¤åŒåæ’ä»¶çš„æ—§è®°å½•ï¼ˆæ ¹æ®æ’ä»¶åå’Œä½œè€…ï¼‰
          if [ -s "$INDEX" ]; then
            jq -c --arg p "$PLUGIN" --arg a "$AUTHOR" \
              'select(.plugin != $p or .author != $a)' "$INDEX" > "$INDEX.tmp" || true
          else
            touch "$INDEX.tmp"
          fi

          # è¿½åŠ æ–°è®°å½•
          echo "$NEW" >> "$INDEX.tmp"

          # åŸå­æ›¿æ¢
          mv "$INDEX.tmp" "$INDEX"
          
          echo "ç´¢å¼•å·²æ›´æ–°:"
          cat "$INDEX"

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add amll-plugin
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          
          git commit -m "Publish ${{ steps.meta.outputs.NAME }} v${{ steps.meta.outputs.VERSION }}"
          git push

      - name: è¯„è®º PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ æ’ä»¶ **${{ steps.meta.outputs.NAME }}** v${{ steps.meta.outputs.VERSION }} å·²æˆåŠŸå‘å¸ƒï¼`
            });              return match ? match[1].trim() : '';
            };
            
            // æå–å„å­—æ®µ
            let name = get('æ’ä»¶å');
            let author = get('ä½œè€…').replace(/^@/, '');
            const version = get('ç‰ˆæœ¬å·');
            const desc = get('ç®€ä»‹');
            const filename = get('æ–‡ä»¶å');
            
            // å¦‚æœæ’ä»¶åä¸ºç©ºï¼Œå°è¯•ä»æ ‡é¢˜æå–
            if (!name) {
              // å¤„ç† "æ’ä»¶ä¸Šä¼ : XXX" æ ¼å¼
              const titleMatch = title.match(/æ’ä»¶ä¸Šä¼ [ï¼š:]\s*(.+)$/);
              if (titleMatch) {
                name = titleMatch[1].trim();
              } else {
                // å¤„ç† "Add plugin XXX from #123" æ ¼å¼
                const addMatch = title.match(/^Add plugin\s+(.+?)\s+from\s+#\d+$/);
                if (addMatch) {
                  name = addMatch[1].trim();
                }
              }
            }
            
            // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶åï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼‰
            const safeName = name.replace(/[^a-zA-Z0-9_\u4e00-\u9fa5-]/g, '_').toLowerCase();
            
            console.log('è§£æç»“æœ:');
            console.log('NAME:', name);
            console.log('SAFE_NAME:', safeName);
            console.log('AUTHOR:', author);
            console.log('VERSION:', version);
            console.log('DESC:', desc);
            console.log('FILENAME:', filename);
            
            core.setOutput('NAME', name);
            core.setOutput('SAFE_NAME', safeName);
            core.setOutput('AUTHOR', author);
            core.setOutput('VERSION', version);
            core.setOutput('DESC', desc);
            core.setOutput('FILENAME', filename);

      - name: éªŒè¯å¿…å¡«å­—æ®µ
        run: |
          NAME="${{ steps.meta.outputs.NAME }}"
          AUTHOR="${{ steps.meta.outputs.AUTHOR }}"
          FILENAME="${{ steps.meta.outputs.FILENAME }}"
          
          if [ -z "$NAME" ] || [ -z "$FILENAME" ]; then
            echo "é”™è¯¯: ç¼ºå°‘å¿…å¡«å­—æ®µ"
            echo "NAME=[$NAME]"
            echo "AUTHOR=[$AUTHOR]"
            echo "FILENAME=[$FILENAME]"
            exit 1
          fi

      - name: è°ƒè¯•ä¿¡æ¯
        run: |
          echo "==== æå–çš„å…ƒæ•°æ® ===="
          echo "NAME=[${{ steps.meta.outputs.NAME }}]"
          echo "SAFE_NAME=[${{ steps.meta.outputs.SAFE_NAME }}]"
          echo "AUTHOR=[${{ steps.meta.outputs.AUTHOR }}]"
          echo "VERSION=[${{ steps.meta.outputs.VERSION }}]"
          echo "FILENAME=[${{ steps.meta.outputs.FILENAME }}]"
          echo ""
          echo "==== raw-plugin ç›®å½•å†…å®¹ ===="
          ls -lh raw-plugin/ || echo "raw-plugin ç›®å½•ä¸å­˜åœ¨"
          echo ""
          echo "==== æŸ¥æ‰¾å¯èƒ½çš„ SVG æ–‡ä»¶ ===="
          find raw-plugin -name "*.svg" -type f 2>/dev/null || echo "æœªæ‰¾åˆ° SVG æ–‡ä»¶"

      - name: å¤åˆ¶æ’ä»¶åˆ°å‘å¸ƒç›®å½•
        run: |
          SRC="raw-plugin/${{ steps.meta.outputs.FILENAME }}"
          
          # ç”Ÿæˆç›®æ ‡æ–‡ä»¶å
          if [ -n "${{ steps.meta.outputs.AUTHOR }}" ]; then
            DST="amll-plugin/${{ steps.meta.outputs.SAFE_NAME }}-${{ steps.meta.outputs.AUTHOR }}.js"
          else
            DST="amll-plugin/${{ steps.meta.outputs.SAFE_NAME }}.js"
          fi
          
          mkdir -p amll-plugin
          
          # æ£€æŸ¥æºæ–‡ä»¶
          if [ ! -f "$SRC" ]; then
            echo "é”™è¯¯: æºæ–‡ä»¶ä¸å­˜åœ¨: $SRC"
            echo "raw-plugin ç›®å½•å†…å®¹:"
            ls -la raw-plugin/
            exit 1
          fi
          
          # å¤åˆ¶æ’ä»¶æ–‡ä»¶
          cp "$SRC" "$DST"
          echo "å·²å¤åˆ¶æ’ä»¶: $SRC -> $DST"
          
          # æŸ¥æ‰¾å¹¶å¤åˆ¶å›¾æ ‡ï¼ˆä½¿ç”¨ SAFE_NAMEï¼‰
          # å°è¯•å¤šç§å¯èƒ½çš„æ–‡ä»¶å
          ICON_DST="${DST%.js}.svg"
          FOUND_ICON=false
          
          for ICON_SRC in \
            "raw-plugin/${{ steps.meta.outputs.SAFE_NAME }}.svg" \
            "raw-plugin/${{ steps.meta.outputs.NAME }}.svg"; do
            if [ -f "$ICON_SRC" ]; then
              cp "$ICON_SRC" "$ICON_DST"
              echo "å·²å¤åˆ¶å›¾æ ‡: $ICON_SRC -> $ICON_DST"
              FOUND_ICON=true
              break
            fi
          done
          
          if [ "$FOUND_ICON" = false ]; then
            echo "è­¦å‘Š: æœªæ‰¾åˆ°å›¾æ ‡æ–‡ä»¶ï¼Œå·²è·³è¿‡"
          fi
          
      - name: ç”Ÿæˆç´¢å¼•
        run: |
          INDEX="amll-plugin/index.jsonl"
          PLUGIN="${{ steps.meta.outputs.NAME }}"
          AUTHOR="${{ steps.meta.outputs.AUTHOR }}"
          SAFE_NAME="${{ steps.meta.outputs.SAFE_NAME }}"
          
          # ç”Ÿæˆæ–‡ä»¶å
          if [ -n "$AUTHOR" ]; then
            FILENAME="${SAFE_NAME}-${AUTHOR}.js"
            ICON_NAME="${SAFE_NAME}-${AUTHOR}.svg"
          else
            FILENAME="${SAFE_NAME}.js"
            ICON_NAME="${SAFE_NAME}.svg"
          fi
          
          # æ£€æŸ¥å›¾æ ‡æ˜¯å¦å­˜åœ¨
          if [ -f "amll-plugin/$ICON_NAME" ]; then
            HAS_ICON=true
          else
            HAS_ICON=false
            ICON_NAME=""
          fi
          
          # åˆ›å»ºæ–°è®°å½•
          if [ "$HAS_ICON" = true ]; then
            NEW=$(jq -n \
              --arg fn "$FILENAME" \
              --arg icon "$ICON_NAME" \
              --arg name "$PLUGIN" \
              --arg desc "${{ steps.meta.outputs.DESC }}" \
              --arg author "$AUTHOR" \
              --arg version "${{ steps.meta.outputs.VERSION }}" \
              '{filename:$fn, icon:$icon, plugin:$name, description:$desc, author:$author, version:$version}')
          else
            NEW=$(jq -n \
              --arg fn "$FILENAME" \
              --arg name "$PLUGIN" \
              --arg desc "${{ steps.meta.outputs.DESC }}" \
              --arg author "$AUTHOR" \
              --arg version "${{ steps.meta.outputs.VERSION }}" \
              '{filename:$fn, plugin:$name, description:$desc, author:$author, version:$version}')
          fi

          # åˆ›å»ºç´¢å¼•æ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          touch "$INDEX"

          # åˆ é™¤åŒåæ’ä»¶çš„æ—§è®°å½•ï¼ˆæ ¹æ®æ’ä»¶åå’Œä½œè€…ï¼‰
          if [ -s "$INDEX" ]; then
            jq -c --arg p "$PLUGIN" --arg a "$AUTHOR" \
              'select(.plugin != $p or .author != $a)' "$INDEX" > "$INDEX.tmp" || true
          else
            touch "$INDEX.tmp"
          fi

          # è¿½åŠ æ–°è®°å½•
          echo "$NEW" >> "$INDEX.tmp"

          # åŸå­æ›¿æ¢
          mv "$INDEX.tmp" "$INDEX"
          
          echo "ç´¢å¼•å·²æ›´æ–°:"
          cat "$INDEX"

      - name: æäº¤å¹¶æ¨é€
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add amll-plugin
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi
          
          git commit -m "Publish ${{ steps.meta.outputs.NAME }} v${{ steps.meta.outputs.VERSION }}"
          git push

      - name: è¯„è®º PR
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ‰ æ’ä»¶ **${{ steps.meta.outputs.NAME }}** v${{ steps.meta.outputs.VERSION }} å·²æˆåŠŸå‘å¸ƒï¼`
            });      - name: å¤åˆ¶æ’ä»¶å‰è°ƒè¯•
        run: |
          echo "FILENAME=[${{ steps.meta.outputs.FILENAME }}]"
          echo "NAME=[${{ steps.meta.outputs.NAME }}]"
          echo "AUTHOR=[${{ steps.meta.outputs.AUTHOR }}]"
          ls -l raw-plugin/

      - name: å¤åˆ¶æ’ä»¶åˆ°å‘å¸ƒç›®å½•
        run: |
          SRC="raw-plugin/${{ steps.meta.outputs.FILENAME }}"
          DST="amll-plugin/${{ steps.meta.outputs.NAME }}-${{ steps.meta.outputs.AUTHOR }}.js"
          mkdir -p amll-plugin
          test -f "$SRC" || { echo "æºæ–‡ä»¶ $SRC ä¸å­˜åœ¨"; exit 1; }
          cp "$SRC" "$DST"
          # å¤åˆ¶å›¾æ ‡
          ICON_SRC="raw-plugin/${{ steps.meta.outputs.NAME }}.svg"
          ICON_DST="amll-plugin/${{ steps.meta.outputs.NAME }}-${{ steps.meta.outputs.AUTHOR }}.svg"
          test -f "$ICON_SRC" && cp "$ICON_SRC" "$ICON_DST"
          
      - name: ç”Ÿæˆç´¢å¼•
        run: |
          INDEX="amll-plugin/index.jsonl"
          PLUGIN="${{ steps.meta.outputs.NAME }}"
          AUTHOR="${{ steps.meta.outputs.AUTHOR }}"
          NEW=$(jq -n \
          --arg fn  "${{ steps.meta.outputs.NAME }}-${{ steps.meta.outputs.AUTHOR }}.js" \
          --arg icon "${{ steps.meta.outputs.NAME }}-${{ steps.meta.outputs.AUTHOR }}.svg" \
          --arg name "${{ steps.meta.outputs.NAME }}" \
          --arg desc "${{ steps.meta.outputs.DESC }}" \
          --arg author "${{ steps.meta.outputs.AUTHOR }}" \
          '{filename:$fn, icon:$icon, plugin:$name, description:$desc, author:$author}')

          # åˆ é™¤æ—§è®°å½•
          jq -c --arg p "$PLUGIN" --arg a "$AUTHOR" \
            'select(.plugin != $p or .author != $a)' "$INDEX" 2>/dev/null > "$INDEX.tmp" || true

          # è¿½åŠ æ–°è®°å½•
          echo "$NEW" >> "$INDEX.tmp"

          # åŸå­æ›¿æ¢
          mv "$INDEX.tmp" "$INDEX"



      - name: æäº¤å¹¶æ¨é€
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[actions]@users.noreply.github.com"
          git add amll-plugin
          git diff --cached --quiet && exit 0
          git commit -m "Publish ${{ steps.meta.outputs.NAME }} v${{ steps.meta.outputs.VERSION }}"
          git push
